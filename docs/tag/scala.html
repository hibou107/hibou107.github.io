<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>My technical blog - scala</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">My technical blog </a></h1>
                <nav><ul>
                    <li><a href="/category/scala.html">scala</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/designing-a-json-migration-tool.html">Designing a json migration tool</a></h1>
<footer class="post-info">
        <abbr class="published" title="2017-12-22T10:20:00+01:00">
                Published: ven. 22 décembre 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hoai-nam-nguyen.html">Hoai Nam NGUYEN</a>
        </address>
<p>In <a href="/category/scala.html">scala</a>.</p>
<p>tags: <a href="/tag/scala.html">scala</a> <a href="/tag/json.html">json</a> </p>
</footer><!-- /.post-info --><h1>The problems</h1>
<p>Json is probably the most popular data format today. It's used both for data exchange (between front-end and backend for example). It's also used to store inside database like <code>MongoDB</code>, even <a href="https://www.postgresql.org/docs/9.3/static/functions-json.html"><code>postgresql</code></a> supports json data type.</p>
<p>Working with <code>json</code> means defining 2 functions:</p>
<ul>
<li>A Writer that converts an object into <code>json</code> format</li>
<li>A Reader that reads a <code>json</code> and produces an object</li>
</ul>
<p>An example of this use case is:</p>
<div class="highlight"><pre><span></span><span class="k">case</span> <span class="k">class</span> <span class="nc">Model</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</pre></div>


<p>In <a href="https://github.com/playframework/play-json"><code>play-json</code></a>, we can define a <code>Format</code> and uses the macro helper to automatically define a <code>Reader</code> and a <code>Writer</code> of <code>Model</code></p>
<div class="highlight"><pre><span></span><span class="k">implicit</span> <span class="k">val</span> <span class="n">modelFormat</span><span class="k">:</span> <span class="kt">Format</span><span class="o">[</span><span class="kt">Model</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">format</span><span class="o">[</span><span class="kt">Model</span><span class="o">]</span>
</pre></div>


<p>This is an example value:</p>
<div class="highlight"><pre><span></span><span class="p">{</span> <span class="err">“x”:</span> <span class="err">“toto”,</span> <span class="err">“y”:</span> <span class="err">“tata”</span> <span class="p">}</span>
</pre></div>


<p>Everything works perfectly and now the json data is persisted in database and test folder.</p>
<p>One day the client want to add one more field in the model, the new model should be:</p>
<div class="highlight"><pre><span></span><span class="k">case</span> <span class="k">class</span> <span class="nc">Model</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">z</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
</pre></div>


<p>We don't need to modify the <code>Format</code> because the macro takes care of it automatically.</p>
<p>But what about the old json format? The current format cannot read the old json data because it lacks <code>z</code></p>
<p>Now we should find a solution in order to be able to read the old json format by setting the <code>z</code> to a default value</p>
<h1>First solution</h1>
<p>We've found a quick solution to the problem. We can for example define a <code>Reader</code> that can read both current and old version.</p>
<p>The first thing we should do is to split the <code>Format</code> into <code>Reader</code> and <code>Writer</code>:</p>
<div class="highlight"><pre><span></span><span class="k">implicit</span> <span class="k">val</span> <span class="n">modelReads</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">Model</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span>
  <span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;x&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
  <span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;y&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
<span class="o">)(</span><span class="nc">Model</span><span class="o">.</span><span class="n">apply</span> <span class="k">_</span><span class="o">)</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">modelWrites</span><span class="k">:</span> <span class="kt">Writes</span><span class="o">[</span><span class="kt">Model</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span>
  <span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;x&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Double</span><span class="o">]</span> <span class="n">and</span>
  <span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;y&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Double</span><span class="o">]</span>
<span class="o">)(</span><span class="n">unlift</span><span class="o">(</span><span class="nc">Model</span><span class="o">.</span><span class="n">unapply</span><span class="o">))</span>
</pre></div>


<p>Then we define two versions of the <code>Reader</code>:</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">modelReadsV0</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">Model</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span>
  <span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;x&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
  <span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;y&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
  <span class="nc">Reads</span><span class="o">.</span><span class="n">pure</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
<span class="o">)(</span><span class="nc">Model</span><span class="o">.</span><span class="n">apply</span> <span class="k">_</span><span class="o">)</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">modelReadsV1</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">Model</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span>
  <span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;x&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
  <span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;y&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
  <span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;z&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
<span class="o">)(</span><span class="nc">Model</span><span class="o">.</span><span class="n">apply</span> <span class="k">_</span><span class="o">)</span> <span class="n">orElse</span> <span class="n">modelReadsV0</span>
</pre></div>


<p>The system works like that: the implicit readers is always in the last version. If the <code>ReaderV1</code> can not read the <code>json</code>, its used the <code>ReaderV0</code> which defines a default value for the field <code>z</code></p>
<p>But the problems of this design are:</p>
<ul>
<li>If we add or remove a field, we need to update all the readers</li>
<li>Do not work in more complicated cases: move a field to a nother place, rename a field, change value of a field</li>
<li>Splitting <code>Format</code> to <code>Reader</code> and <code>Writer</code> can cause a Reader/Writer mismatch. We need to add a lot of tests </li>
</ul>
<h1>Second solution</h1>
<h2>Imperative vs Functional</h2>
<p>The solution is to clone the SQL migration design: Each migration is defined by a script.</p>
<p>The question is how we define this migration script. The <code>JsValue</code> is immutable and creating new value from the old one is tedious. I am a fan of functional programming but this is where the imperative way is much more easy. For example </p>
<table>
<thead>
<tr>
<th>Imperative way</th>
<th>Functional way</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>x.y.z += 1</code></td>
<td><code>x.copy(y = x.y.copy(z = x.y.z + 1))</code></td>
</tr>
<tr>
<td><code>value[“key25”] = {“key251”: value[“key2”][“key21”]}</code></td>
<td><code>(__ \ 'key25 \ 'key251).json.copyFrom( (__ \ 'key2 \ 'key21).json.pick )</code></td>
</tr>
</tbody>
</table>
<p>I write the library for a team of both functional and less functional programer in the team. It should be easy to write migration script and the functional way is very hard for this task. Moreover, for the advanced task it's near impossible to do. For example, let's say we want to modify all the <code>JsObject</code> that has the field <code>toto</code> and change the field value to 0. An example of this json value is:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
<span class="err">“X”:</span>  <span class="err">{</span> <span class="err">“toto”:</span> <span class="err">0</span> <span class="p">}</span><span class="err">,</span>
<span class="err">“Y”:</span>  <span class="p">[{</span><span class="err">“toto”:</span> <span class="err">1</span><span class="p">},</span> <span class="p">{</span><span class="err">“tata”:</span> <span class="err">2</span><span class="p">}</span> <span class="p">]</span><span class="err">,</span>
<span class="err">“Z”</span> <span class="err">:</span>  <span class="p">{</span> <span class="err">“zz”:</span> <span class="err">{“toto”:</span> <span class="err">2</span><span class="p">}</span><span class="err">}</span>
<span class="err">}</span>
</pre></div>


<p>The value that we want to modify can be inside a field, nested in 2 levels fields or even inside an array. Updating these values in a functional way is hard and the only way I've found is using advanced concept like <a href="https://en.wikipedia.org/wiki/Zipper_(data_structure)">the zipper</a></p>
<p>All the difficulties lead to the obvious solution: convert temporary immutable value into mutable version, applying changes and convert back to the original value</p>
<h2>Wrapper for mutable version</h2>
<p>Let's define a <code>trait</code> for this new data struture:</p>
<div class="highlight"><pre><span></span><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">JsValueWrapper</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">JsObjectWrapper</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">collection.mutable.Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">JsValueWrapper</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">JsValueWrapper</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">JsStringWrapper</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">JsValueWrapper</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">JsArrayWrapper</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">ArrayBuffer</span><span class="o">[</span><span class="kt">JsValueWrapper</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">JsValueWrapper</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">JsBooleanWrapper</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">JsValueWrapper</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">JsNumberWrapper</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">BigDecimal</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">JsValueWrapper</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">JsNUllWrapper</span> <span class="k">extends</span> <span class="nc">JsValueWrapper</span>
</pre></div>


<p>This build an equivalent of all the possbile values of <code>JsValue</code>. The only difference is the <code>JsObjectWrapper</code> and <code>JsArrayWrapper</code> use mutable collection internally</p>
<h2>Conversion functions</h2>
<p>Let's define 2 methods to convert between <code>JsValue</code> and <code>JsValueWrapper</code>. Of course there are some recursivities when dealing with <code>JsObject</code> and <code>JsArray</code></p>
<div class="highlight"><pre><span></span><span class="k">implicit</span> <span class="k">def</span> <span class="n">create</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">JsValue</span><span class="o">)</span><span class="k">:</span> <span class="kt">JsValueWrapper</span> <span class="o">=</span>
   <span class="n">input</span> <span class="k">match</span> <span class="o">{</span>
     <span class="k">case</span> <span class="n">x</span><span class="k">:</span> <span class="kt">JsObject</span>    <span class="o">=&gt;</span> <span class="nc">JsObjectWrapper</span><span class="o">(</span><span class="n">collection</span><span class="o">.</span><span class="n">mutable</span><span class="o">.</span><span class="nc">Map</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">mapValues</span><span class="o">(</span><span class="n">create</span><span class="o">).</span><span class="n">toSeq</span><span class="k">:</span> <span class="k">_</span><span class="kt">*</span><span class="o">))</span>
     <span class="k">case</span> <span class="n">x</span><span class="k">:</span> <span class="kt">JsArray</span>     <span class="o">=&gt;</span> <span class="nc">JsArrayWrapper</span><span class="o">(</span><span class="nc">ArrayBuffer</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="k">:</span> <span class="k">_</span><span class="kt">*</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">create</span><span class="o">))</span>
     <span class="k">case</span> <span class="n">x</span><span class="k">:</span> <span class="kt">JsString</span>    <span class="o">=&gt;</span> <span class="nc">JsStringWrapper</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
     <span class="k">case</span> <span class="n">x</span><span class="k">:</span> <span class="kt">JsBoolean</span>   <span class="o">=&gt;</span> <span class="nc">JsBooleanWrapper</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
     <span class="k">case</span> <span class="n">x</span><span class="k">:</span> <span class="kt">JsNumber</span>    <span class="o">=&gt;</span> <span class="nc">JsNumberWrapper</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
     <span class="k">case</span> <span class="nc">JsNull</span>         <span class="k">=&gt;</span> <span class="nc">JsNUllWrapper</span>
   <span class="o">}</span>



<span class="k">implicit</span> <span class="k">def</span> <span class="n">toJson</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">JsValueWrapper</span><span class="o">)</span><span class="k">:</span> <span class="kt">JsValue</span> <span class="o">=</span> <span class="o">{</span>
<span class="n">input</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">x</span><span class="k">:</span> <span class="kt">JsObjectWrapper</span>    <span class="o">=&gt;</span> <span class="nc">JsObject</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">toJson</span><span class="o">(</span><span class="n">value</span><span class="o">))</span> <span class="o">}.</span><span class="n">toSeq</span><span class="o">)</span>
    <span class="k">case</span> <span class="n">x</span><span class="k">:</span> <span class="kt">JsArrayWrapper</span>     <span class="o">=&gt;</span> <span class="nc">JsArray</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">toJson</span><span class="o">))</span>
    <span class="k">case</span> <span class="n">x</span><span class="k">:</span> <span class="kt">JsStringWrapper</span>    <span class="o">=&gt;</span> <span class="nc">JsString</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
    <span class="k">case</span> <span class="n">x</span><span class="k">:</span> <span class="kt">JsBooleanWrapper</span>   <span class="o">=&gt;</span> <span class="nc">JsBoolean</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
    <span class="k">case</span> <span class="n">x</span><span class="k">:</span> <span class="kt">JsNumberWrapper</span>    <span class="o">=&gt;</span> <span class="nc">JsNumber</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">JsNUllWrapper</span>         <span class="k">=&gt;</span> <span class="nc">JsNull</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2>Script</h2>
<p>Let's define a <code>trait</code> that defines a method <code>migrate</code> that make in place modification</p>
<div class="highlight"><pre><span></span><span class="k">trait</span> <span class="nc">JsonMigrator</span> <span class="o">{</span>
 <span class="k">def</span> <span class="n">migrate</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">JsValueWrapper</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span>
 <span class="k">def</span> <span class="n">transform</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">JsValueWrapper</span><span class="o">)</span><span class="k">:</span> <span class="kt">JsValueWrapper</span> <span class="o">=</span> <span class="o">{</span>
   <span class="n">migrate</span><span class="o">(</span><span class="n">input</span><span class="o">)</span>
   <span class="n">input</span>
 <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>We should define a way to combine multiple scripts to form a global script. This operation is called <code>append</code> and if we can define a neutral script (a script that does nothing), then we can define a <code>Monoid</code> instance</p>
<div class="highlight"><pre><span></span><span class="k">implicit</span> <span class="k">val</span> <span class="n">monoid</span><span class="k">:</span> <span class="kt">Monoid</span><span class="o">[</span><span class="kt">JsonMigrator</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Monoid</span><span class="o">[</span><span class="kt">JsonMigrator</span><span class="o">]</span> <span class="o">{</span>
   <span class="k">def</span> <span class="n">zero</span><span class="k">:</span> <span class="kt">JsonMigrator</span> <span class="o">=</span> <span class="o">(</span><span class="k">_:</span> <span class="kt">JsValueWrapper</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">()</span>
   <span class="k">def</span> <span class="n">append</span><span class="o">(</span><span class="n">f1</span><span class="k">:</span> <span class="kt">JsonMigrator</span><span class="o">,</span> <span class="n">f2</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="nc">JsonMigrator</span><span class="o">)</span><span class="k">:</span> <span class="kt">JsonMigrator</span> <span class="o">=</span> <span class="o">{</span>
     <span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">JsValueWrapper</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
       <span class="n">f1</span><span class="o">.</span><span class="n">migrate</span><span class="o">(</span><span class="n">input</span><span class="o">)</span>
       <span class="n">f2</span><span class="o">.</span><span class="n">migrate</span><span class="o">(</span><span class="n">input</span><span class="o">)</span>
     <span class="o">}</span>
   <span class="o">}</span>
 <span class="o">}</span>
</pre></div>


<h2>Some helpers</h2>
<p>We should create some conversion implicit to help our users write more concise migration code. But it's not a safe operation because the <code>asInstanceOf</code> can throw exceptions</p>
<div class="highlight"><pre><span></span><span class="k">implicit</span> <span class="k">class</span> <span class="nc">JsObjectWrapperConverter</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">JsValueWrapper</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">field</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">JsValueWrapper</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">JsObjectWrapper</span><span class="o">].</span><span class="n">value</span><span class="o">(</span><span class="n">field</span><span class="o">)</span>
   <span class="k">def</span> <span class="n">number</span><span class="k">:</span> <span class="kt">BigDecimal</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">JsNumberWrapper</span><span class="o">].</span><span class="n">value</span>
   <span class="k">def</span> <span class="n">map</span><span class="k">:</span> <span class="kt">mutable.Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">JsValueWrapper</span><span class="o">]</span> <span class="k">=</span> <span class="n">input</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">JsObjectWrapper</span><span class="o">].</span><span class="n">value</span>
   <span class="k">def</span> <span class="n">setDefault</span><span class="o">(</span><span class="n">field</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">JsValueWrapper</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
     <span class="k">if</span> <span class="o">(!</span><span class="n">has</span><span class="o">(</span><span class="n">field</span><span class="o">))</span>
       <span class="n">input</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">JsObjectWrapper</span><span class="o">].</span><span class="n">map</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span>
   <span class="o">}</span>
   <span class="k">def</span> <span class="n">remove</span><span class="o">(</span><span class="n">field</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">JsValueWrapper</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
     <span class="n">input</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">JsObjectWrapper</span><span class="o">].</span><span class="n">map</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="n">field</span><span class="o">)</span>
   <span class="o">}</span>
</pre></div>


<h2>Examples</h2>
<p>Let's say we have 3 migrations:</p>
<div class="highlight"><pre><span></span><span class="k">private</span> <span class="k">val</span> <span class="n">migrator1</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">JsonMigrator</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">migrate</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">JsValueWrapper</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
      <span class="n">x</span><span class="o">(</span><span class="s">&quot;field1&quot;</span><span class="o">).</span><span class="n">map</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="s">&quot;field11&quot;</span><span class="o">)</span>
      <span class="o">()</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="k">private</span> <span class="k">val</span> <span class="n">migrator2</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">JsonMigrator</span> <span class="o">{</span> <span class="c1">// add new field field1/field12</span>
<span class="k">def</span> <span class="n">migrate</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">JsValueWrapper</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span>
  <span class="n">input</span><span class="o">(</span><span class="s">&quot;field1&quot;</span><span class="o">).</span><span class="n">map</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="s">&quot;field12&quot;</span><span class="o">,</span> <span class="s">&quot;myNewField&quot;</span><span class="o">)</span>

<span class="k">private</span> <span class="k">val</span> <span class="n">migrator3</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">JsonMigrator</span> <span class="o">{</span> <span class="c1">//  Change all sFields to &quot;hahaha&quot;</span>
<span class="k">def</span> <span class="n">migrate</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">JsValueWrapper</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span>
  <span class="nc">PathResolver</span><span class="o">.</span><span class="n">migrate</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="nc">List</span><span class="o">(</span><span class="nc">RecurFieldCond</span><span class="o">(</span><span class="nc">HasField</span><span class="o">(</span><span class="s">&quot;sField&quot;</span><span class="o">))))</span> <span class="o">{</span> <span class="n">w</span> <span class="k">=&gt;</span>
    <span class="n">w</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="s">&quot;sField&quot;</span><span class="o">,</span><span class="s">&quot;hahaha&quot;</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>We can create a global migrator because we've already defined the <code>Monoid</code> for it</p>
<div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">scalaz.syntax.foldable._</span>
<span class="k">import</span> <span class="nn">scalaz.std.list._</span>
<span class="k">val</span> <span class="n">globalMigrator</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="n">migrator1</span><span class="o">,</span> <span class="n">migrator2</span><span class="o">,</span> <span class="n">migrator3</span><span class="o">).</span><span class="n">suml</span>
</pre></div>


<p>Now with the global script, we convert the immutable json value into the mutable version, transform it and convert back to the immutable version</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">x</span> <span class="k">=</span> <span class="nc">JsValueWrapper</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">json</span><span class="o">)</span> <span class="c1">// first we need to create a mutable version of the original json</span>
<span class="n">allMigrator</span><span class="o">.</span><span class="n">migrate</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="c1">// then mutate it by applying the global migration</span>
<span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="nc">JsValueWrapper</span><span class="o">.</span><span class="n">toJson</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> 
</pre></div>


<h2>Integration into deployment system</h2>
<p>This is just an example how we can automatically migrate a database with a lot of json: The database store the current version somewhere. When executing a migration, the proram fetches the current version and find all the migration scripts, combine them to make a global script, iterate all the json value in database, convert to mutable versiont, transform it with the global script and finally convert it back to the immutable version</p>
<p>The users have to maintain a file that defines the mapping between version and script:</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">l</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
  <span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">migration1</span><span class="o">),</span>
  <span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">migration2</span><span class="o">),</span>
  <span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">migration3</span><span class="o">)</span>
<span class="o">)</span>
</pre></div>


<p>If 2 users modify the file at the same time, they have to resolve conflict during the merge</p>
<h2>Integration into the test system</h2>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="/developing-a-json-migration-tool.html" rel="bookmark"
                           title="Permalink to Developing a json migration tool">Developing a json migration tool</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-12-07T10:20:00+01:00">
                Published: jeu. 07 décembre 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hoai-nam-nguyen.html">Hoai Nam NGUYEN</a>
        </address>
<p>In <a href="/category/scala.html">scala</a>.</p>
<p>tags: <a href="/tag/scala.html">scala</a> <a href="/tag/json.html">json</a> </p>
</footer><!-- /.post-info -->                <h1>json-migration</h1>
<p>This <a href="http://hibou107.github.io/developing-a-json-migration-tool.html">project</a> tries to help building a json migration framework in the same way of a database migration tool.</p>
<p>The <code>json</code> libary used in this example is <code>play-json</code></p>
<p>The aim of this project is to make the migration script easy to write by people who does not have much …</p>
                <a class="readmore" href="/developing-a-json-migration-tool.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://www.linkedin.com/in/hoai-nam-nguyen-47664113">LinkedIn</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://www.linkedin.com/in/hoai-nam-nguyen-47664113">LinkedIn</a></li>
                            <li><a href="https://github.com/hibou107">GitHub</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>